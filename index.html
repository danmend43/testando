<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Spotify BPM Visualizer</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #121212;
    color: white;
    text-align: center;
    padding-top: 50px;
  }
  #login {
    padding: 15px 40px;
    font-size: 1.3em;
    background-color: #1DB954;
    color: white;
    border: none;
    border-radius: 30px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  #login:hover {
    background-color: #1ed760cc;
  }
  #cover {
    margin-top: 40px;
    width: 300px;
    height: 300px;
    border: 8px solid #1DB954;
    border-radius: 50%; /* redondo */
    box-sizing: border-box;
    transition: box-shadow 0.15s ease;
    display: none;
    cursor: pointer;
  }
</style>
</head>
<body>

<button id="login">Logar com Spotify</button>
<img id="cover" alt="Capa da MÃºsica" />

<script>
  const client_id = '384115184ce848c1bf39bdd8d0209f83'; // substitua pelo seu Client ID Spotify
  const redirect_uri = 'https://testando-pp9x.vercel.app/callback'; // ajuste pra sua URL
  const scopes = 'user-read-currently-playing user-read-playback-state';

  const loginBtn = document.getElementById('login');
  const cover = document.getElementById('cover');

  function login() {
    const authEndpoint = 'https://accounts.spotify.com/authorize';
    const url = `${authEndpoint}?client_id=${client_id}&redirect_uri=${encodeURIComponent(redirect_uri)}&scope=${encodeURIComponent(scopes)}&response_type=token&show_dialog=true`;
    window.location = url;
  }

  loginBtn.addEventListener('click', login);

  function getTokenFromUrl() {
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    return params.get('access_token');
  }

  async function fetchCurrentTrack(token) {
    try {
      const res = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
        headers: { Authorization: 'Bearer ' + token }
      });
      if (res.status === 204 || res.status > 400) return null;
      const data = await res.json();
      if (!data || !data.item) return null;
      return data.item;
    } catch {
      return null;
    }
  }

  async function fetchAudioFeatures(token, trackId) {
    const res = await fetch(`https://api.spotify.com/v1/audio-features/${trackId}`, {
      headers: { Authorization: 'Bearer ' + token }
    });
    if (!res.ok) return null;
    return await res.json();
  }

  function startVisualizer(token) {
    loginBtn.style.display = 'none';
    cover.style.display = 'block';

    let currentTrackId = null;
    let pulseInterval;

    async function update() {
      const track = await fetchCurrentTrack(token);
      if (!track) {
        cover.src = '';
        cover.style.boxShadow = 'none';
        return;
      }
      if (track.id !== currentTrackId) {
        currentTrackId = track.id;
        cover.src = track.album.images[0].url;
      }
      const features = await fetchAudioFeatures(token, currentTrackId);
      if (!features || !features.tempo) return;

      const bpm = features.tempo;
      const interval = 60000 / bpm;

      function pulse() {
        cover.style.boxShadow = '0 0 40px 15px #1DB954';
        setTimeout(() => {
          cover.style.boxShadow = 'none';
        }, interval / 2);
      }

      pulse();
      clearInterval(pulseInterval);
      pulseInterval = setInterval(pulse, interval);
    }

    update();
    setInterval(update, 10000);

    // Se quiser, pode dar reload se clicar na capa pra atualizar manualmente
    cover.addEventListener('click', update);
  }

  (function init() {
    const tokenFromUrl = getTokenFromUrl();
    if (tokenFromUrl) {
      localStorage.setItem('spotify_token', tokenFromUrl);
      window.history.replaceState({}, document.title, '/'); // limpa o token da URL
    }
    const token = localStorage.getItem('spotify_token');
    if (token) {
      startVisualizer(token);
    } else {
      loginBtn.style.display = 'inline-block';
      cover.style.display = 'none';
    }
  })();
</script>

</body>
</html>
